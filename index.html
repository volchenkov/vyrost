<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>VYROST game</title>
    <style>
    	* {
            padding: 0;
            margin: 0;
        }
    	canvas { 
            background: #eee;
            display: block;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
    let canvas = document.getElementById("canvas");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let ctx = canvas.getContext("2d");

    let config = { 
        INIT_FOOD_COUNT: 50,
        NPC_CREATURES_COUNT: 10,
    };

    let food = [];
    initFood();

    let pCreature = createCreature(false);
    pCreature.id = 0;
    pCreature.speedX = pCreature.maxSpeed / 2;
    pCreature.speedY = pCreature.maxSpeed / 2;
    pCreature.x = canvas.width / 2 - pCreature.sizeX / 2;
    pCreature.y = canvas.height - pCreature.sizeY * 1.2;

    let creatures = [];
    creatures.push(pCreature);
    initNPCCreatures();

    tick();

    function drawCreatures(ctx, creatures) {
        creatures.forEach(c => {
            // draw creature area 
            ctx.beginPath();
            ctx.rect(c.x, c.y, c.sizeX, c.sizeY);
            ctx.fillStyle = c.skin;
            ctx.fill();
            ctx.closePath();

            // draw creature smelling area
            if (!c.npc) {
                ctx.beginPath();
                ctx.arc(c.x + c.sizeX/2, c.y + c.sizeY/2, c.smellingRadius, 0, 2*Math.PI, false);
                ctx.lineWidth = 1;
                ctx.strokeStyle = '#ddd';
                ctx.stroke();
            }
        });
    }

    function drawFood(ctx, food) {
        let coloredFood = pCreature.smelledFood.map(f => f.id) 
        food.forEach(f => {
            ctx.beginPath();
            ctx.rect(f.x, f.y, f.sizeX, f.sizeY);
            ctx.fillStyle = coloredFood.includes(f.id) ? '#43DF39' : '#cceecc'; 
            ctx.fill();
            ctx.closePath();
        });

        ctx.font = "15px Arial";
        ctx.fillText(food.length, 10, 20);
    }

    function collideFood(creatures, food) {
        creatures.forEach(c => {
            food.forEach((f, i) => {
                if (Math.abs(c.x - f.x) <= c.sizeX && Math.abs(c.y - f.y) <= c.sizeY) {
                    c.eat(food);
                    food.splice(i, 1);
                }
            })
        })
    }

    function moveCreatures(creatures) {
        creatures.forEach(c => {
            if (c.x + c.speedX > canvas.width - c.sizeX || c.x + c.speedX < 0) {
                c.speedX = -c.speedX;
            }
            if (c.y + c.speedY > canvas.height - c.sizeY || c.y + c.speedY < 0) {
                c.speedY = -c.speedY;
            }

            c.x += c.speedX;
            c.y += c.speedY;
        });
    }

    function sniffFood(creatures, food) {
        creatures.forEach(c => c.sniff(food))
    }

    function initFood() {
        for (let i = 0; i <= config.INIT_FOOD_COUNT; i++) {
            let foodValue = rnd(10, 20);
            let f = {
                sizeX: foodValue,
                sizeY: foodValue,
                value: foodValue,
                id: i
            }
            f.x = rnd(f.sizeX, canvas.width - f.sizeX)
            f.y = rnd(f.sizeY, canvas.height - f.sizeY)
            
            food.push(f)
        }
    }

    function initNPCCreatures() {
        for (let j = 1; j <= config.NPC_CREATURES_COUNT + 1; j++) {
            let c = createCreature(true)

            c.x = rnd(c.sizeX, canvas.width - c.sizeX);
            c.y = rnd(c.sizeY, canvas.height - c.sizeY);
            c.id = j;

            creatures.push(c);
        }
    }

    function tick() {
        sniffFood(creatures, food);
        collideFood(creatures, food);
        moveCreatures(creatures);
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawFood(ctx, food);
        drawCreatures(ctx, creatures);

        requestAnimationFrame(tick);
    }

    function createCreature(npc) {
        let rndBlue = () => `hsl(240, ${rnd(30, 80)}%, ${rnd(30, 80)}%)`;

        const maxSpeed = rnd(4, 12); 
        const size = rnd(5,20);

        let c = {
            sizeX: size,
            sizeY: size,
            maxSpeed: maxSpeed,
            speedX: plusOrMinus() * (maxSpeed / 2),
            speedY: plusOrMinus() * (maxSpeed / 2),
            skin: !npc ? '#FF008F' : rndBlue(),
            x: 0,
            y: 0,
            satiety: 100,
            npc: npc,
            smellingRadius: Math.max(canvas.width, canvas.height) / 15,
            smelledFood: [],
            id: null
        }

        c.eat = (food) => {
            c.satiety += food.value;
        } 

        c.sniff = (food) => {
            c.smelledFood = food.filter(f => c.smellingRadius > Math.sqrt(Math.pow(f.x - c.x, 2) + Math.pow(f.y - c.y, 2)))
        }

        return c;
    }

    function rnd(min, max) {
        return Math.random() * (max - min) + min;
    }

    function plusOrMinus() {
        return Math.random() < 0.5 ? -1 : 1;
    }
</script>

</body>
</html>